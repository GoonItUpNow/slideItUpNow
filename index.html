<!DOCTYPE html>
<html>
    <head>
        <script type="module">
            import { showDirectoryPicker } from 'https://cdn.jsdelivr.net/npm/file-system-access/lib/es2018.js';

            let params = new URLSearchParams(window.location.search)
            let videoSplittingTime = params.has("videoSplitLength") ? parseInt(params.get("videoSplitLength")) : 60;
            let imageInterval = 20;
            let allFiles = [];
            let inProgress = false;
            let volume = 1.0;

            async function openDir2() {
                try {
                    const folder = await showDirectoryPicker()
                    await loadFiles(folder)
                    inProgress = true
                    for (const e of document.getElementsByClassName("slideshow")) {
                        await startSlideShow(e)
                    }
                } catch(e) {
                    console.log(e)
                }
            }

            async function loadFiles(folder) {
                allFiles = []
                let videoFiles = []
                await loadFolder(folder, videoFiles)
                const {shortVideos, longVideos} = await loadVideoMetadata(videoFiles)
                allFiles = allFiles.concat(shortVideos)
                allFiles = allFiles.concat(longVideos)
                shuffle(allFiles)
                console.log(allFiles)
            }

            async function loadFolder(folder, videoFiles) {
                let files = await folder.values()
                for await (const file of files) {
                    if (file.kind == 'directory') {
                        await loadFolder(file, videoFiles)
                    } else if (/\.(jpg|jpeg|png|gif|bmp|webp|svg|tiff)$/i.test(file.name)) {
                        allFiles.push({type: 'short', file: file, format: 'image'})
                    } else if (/\.(mp4|webm|ogg|mov|avi|mkv|flv|wmv|3gp)$/i.test(file.name)) {
                        videoFiles.push(file)
                    }
                }
            }

            async function loadVideoMetadata(videoFiles) {
                if (videoFiles.length == 0) {
                    return {shortVideos: [], longVideos: []}
                }
                const longVideos = []
                const shortVideos = []
                document.getElementById("vidTotal").innerText = videoFiles.length + ""
                const cur = document.getElementById("vidCurrent")
                const video = document.createElement('video');
                video.preload = 'metadata';
                let loaded = 0

                return new Promise(async(resolve) => {

                    video.onloadedmetadata = async function() {
                        window.URL.revokeObjectURL(video.src);
                        var duration = video.duration;
                        if (duration > videoSplittingTime) {
                            const video = videoFiles.pop()
                            for (let i = 0; i < Math.ceil(duration/videoSplittingTime); i++) {
                                longVideos.push({type: 'long', file: video, start: i*videoSplittingTime, format: 'video'})
                            }
                        } else {
                            shortVideos.push({type: 'short', file: videoFiles.pop(), format: 'video'})
                        }
                        cur.innerText = ++loaded
                        if (videoFiles.length > 0) {
                            video.src = URL.createObjectURL(await videoFiles[videoFiles.length - 1].getFile())
                        } else {
                            resolve({shortVideos, longVideos})
                        }
                    }

                    video.src = URL.createObjectURL(await videoFiles[videoFiles.length - 1].getFile());
                })
            }

            async function startSlideShow(root) {
                let videoPlayer = root.querySelector(".videoSlide")
                let imgViewer = root.querySelector(".imgSlide")
                let timeout = null
                let prevObjects = []
                
                document.getElementById("welcome").style.display = 'none';
                document.getElementById("slideshow-grid").style.display = 'flex';
                for(const elem of document.getElementsByClassName("slideshow-row")) {
                    elem.style.display = 'flex';
                }
                for(const elem of document.getElementsByClassName("slideshow")) {
                    elem.style.display = 'block';
                }

                async function nextSlide() {
                    if (!root.isConnected) {
                        console.log("removed")
                        return
                    }
                    let file = allFiles.pop()
                    if (file.format === 'video') {
                        timeout = null
                        videoPlayer.src = URL.createObjectURL(await file.file.getFile())
                        prevObjects.push(videoPlayer.src)
                        videoPlayer.play()
                        videoPlayer.style.display = 'block';
                        imgViewer.style.display = 'none';
                        if (file.type === 'long') {
                            videoPlayer.currentTime = file.start
                            timeout = setTimeout(() => nextSlide(), videoSplittingTime*1000)
                        }
                    } else {
                        videoPlayer.pause()
                        imgViewer.src = URL.createObjectURL(await file.file.getFile())
                        prevObjects.push(imgViewer.src)
                        videoPlayer.style.display = 'none';
                        imgViewer.style.display = 'block';
                        timeout = setTimeout(() => nextSlide(), imageInterval*1000)
                    }
                    if (prevObjects.length > 2) {
                        URL.revokeObjectURL(prevObjects.shift())
                    }
                }

                videoPlayer.addEventListener("ended", nextSlide, false)

                nextSlide()

                root.onclick = () => {
                    if (timeout) {
                        clearTimeout(timeout)
                    }
                    nextSlide()
                }
            }

            function shuffle(array) {
                let currentIndex = array.length,  randomIndex;

                // While there remain elements to shuffle.
                while (currentIndex > 0) {

                    // Pick a remaining element.
                    randomIndex = Math.floor(Math.random() * currentIndex);
                    currentIndex--;

                    // And swap it with the current element.
                    [array[currentIndex], array[randomIndex]] = [
                    array[randomIndex], array[currentIndex]];
                }

                return array;
            }

            let settingsBarHeight = 0;
            let draggingVolume = false;
            let volumeSlider = null;
            let volumeControl = null;
            let volumeControlOpen = false;

            function volumeHold() {
                draggingVolume = true;
            }

            function volumeRelease() {
                draggingVolume = false;
            }

            function volumeDrag(event) {
                if (draggingVolume) {
                    let y = event.clientY - settingsBarHeight
                    if (y < 16) {
                        y = 16
                    }
                    if (y > (150 - 16)) {
                        y = 150 - 16
                    }
                    volumeSlider.setAttribute('cy', y)
                    volume = 1 - (y - 16)/(150 - 32)
                    console.log(volume)
                    for (let e of document.getElementsByClassName("videoSlide")) {
                        e.volume = volume
                    }
                }
            }

            function toggleVolume() {
                volumeControlOpen = !volumeControlOpen
                volumeControl.style.display = volumeControlOpen ? 'block' : 'none';
            }

            let horizontalSlides = 1
            let verticalSlides = 1
            let slideshowGrid;

            async function changeGrid() {
                while (slideshowGrid.children.length > verticalSlides) {
                    slideshowGrid.removeChild(slideshowGrid.children[slideshowGrid.children.length - 1])
                }
                while (slideshowGrid.children[0].children.length > horizontalSlides) {
                    for (let i = 0; i < slideshowGrid.children.length; i++) {
                        let removeFrom = slideshowGrid.children[i].children
                        slideshowGrid.children[i].removeChild(removeFrom[removeFrom.length - 1])
                    }
                }
                while (slideshowGrid.children[0].children.length < horizontalSlides) {
                    for (let i = 0; i < slideshowGrid.children.length; i++) {
                        let ssDiv = document.createElement("div")
                        ssDiv.className = "slideshow"
                        let imgDiv = document.createElement("img")
                        imgDiv.className = "imgSlide"
                        let vidDiv = document.createElement("video")
                        vidDiv.className = "videoSlide"
                        vidDiv.setAttribute("controls", "true")
                        vidDiv.volume = volume
                        ssDiv.append(imgDiv)
                        ssDiv.append(vidDiv)
                        slideshowGrid.children[i].append(ssDiv)
                        if (inProgress) {
                            startSlideShow(ssDiv)
                        }
                    }
                }
                while (slideshowGrid.children.length < verticalSlides) {
                    slideshowGrid.append(slideshowGrid.children[0].cloneNode(true))
                    if (inProgress) {
                        for (let child of slideshowGrid.children[slideshowGrid.children.length - 1].children) {
                            startSlideShow(child)
                        }
                    }
                }
                let rowHeight = 100/verticalSlides
                for (let child of document.getElementsByClassName("slideshow-row")) {
                    child.style.height = rowHeight + "%"
                }
            }

            function getPositiveValue(target) {
                let value = target.value
                if (value < 1) {
                    value = 1
                    target.value = 1
                }
                return value
            }

            function setHorizontalSplits(event) {
                horizontalSlides = getPositiveValue(event.target)
                changeGrid()
            }

            function setVerticalSplits(event) {
                verticalSlides = getPositiveValue(event.target)
                changeGrid()
            }

            function bgColorChanged(event) {
                let color = event.target.value.trim()
                if (/^#[0-9a-f]{6}$/i.test(color)) {
                    document.body.style.backgroundColor = color
                }
            }

            async function bgImageChanged(event) {
                var files = !!this.files ? this.files : [];

                // If no files were selected, or no FileReader support, return
                if ( !files.length || !window.FileReader ) return;

                if ( /^image/.test( files[0].type ) ) {
                    var reader = new FileReader();
                    reader.readAsDataURL( files[0] );
                    reader.onloadend = function() {
                        document.body.style.backgroundImage = "url(" + this.result + ")";
                    }

                }
            }

            function clearBgImage() {
                document.body.style.backgroundImage = ""
            }

            function setImageInterval(event) {
                imageInterval = getPositiveValue(event.target)
            }

            function applySettings() {
                let splitIime = getPositiveValue(document.getElementById("videoSplitLength"))
                window.location.search = "videoSplitLength=" + splitIime
            }

            window.onload = () => {
                settingsBarHeight = document.getElementById("bar").offsetHeight
                document.getElementById("browse").onclick = openDir2
                volumeSlider = document.getElementById("volumeSlider")
                volumeSlider.onmousedown = volumeHold
                document.onmouseup = volumeRelease
                document.onmousemove = volumeDrag
                slideshowGrid = document.getElementById("slideshow-grid")
                document.getElementById("horizontalSplits").onchange = setHorizontalSplits
                document.getElementById("verticalSplits").onchange = setVerticalSplits
                document.getElementById("nextImageSec").onchange = setImageInterval
                volumeControl = document.getElementById("volumeControl")
                document.getElementById("volume").onclick = toggleVolume
                document.getElementById("settings").onclick = (event) => { document.getElementById("settingsDialog").style.display = 'block' }
                document.getElementById("settingsClose").onclick = (event) => { document.getElementById("settingsDialog").style.display = 'none' }
                document.getElementById("backgroundColor").oninput = bgColorChanged
                document.getElementById("backgroundImage").onchange = bgImageChanged
                document.getElementById("clearBackgroundImage").onclick = clearBgImage
                document.getElementById("fill").onclick = (event) => { document.body.style.backgroundSize = "cover" }
                document.getElementById("fit").onclick = (event) => { document.body.style.backgroundSize = "contain" }
                document.getElementById("videoSplitLength").value = videoSplittingTime
                document.getElementById("settingsApply").onclick = applySettings
            }

        </script>
        <style>

            html, body {
                width: 100%;
                height: 100%;
                padding: 0;
                margin: 0;
            }

            body {
                background-color: #ffc0cb;
                background-repeat: no-repeat;
                background-size: cover;
                background-position: center;
            }

            #slideshow-grid {
                width: 100%;
                height: 100%;
                display: none;
                float: left;
                position: absolute;
                z-index: 1;
                flex-direction: column;
            }

            .slideshow-row {
                width: 100%;
                height: 100%;
                display: none;
            }

            .slideshow {
                width: 100%;
                height: 100%;
                display: none;
            }

            .imgSlide {
                max-width: 100%;
                max-height: 100%;
                position: relative;
                margin: auto;
                top: 50%;
                -ms-transform: translateY(-50%);
                transform: translateY(-50%);
            }

            #welcome {
                float: left;
                margin-left: 10px;
            }

            .videoSlide {
                max-width: 100%;
                max-height: 100%;
                margin: 0 auto;
                position: relative;
                top: 50%;
                -ms-transform: translateY(-50%);
                transform: translateY(-50%);
            }
            #menu {
                float: right;
                color: lightgray;
            }
            #bar {
                background-color: rgba(0, 0, 0, 0.5);
                padding: 0 5px 5px 5px;
                position: relative;
                z-index: 2;
            }
            #volumeControl {
                width: 40px;
                height: 150px;
                background-color: rgba(0, 0, 0, 0.5);
                float: right;
                position: relative;
                z-index: 2;
                display: none;
            }
            a {
                color: lightgray;
            }
            #settingsDialog {
                width: 400px;
                margin: 0;
                position: absolute;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                background-color: lightgray;
                border: 1px solid black;
                border-radius: 5px;
                padding: 20px;
                z-index: 3;
                display: none;
            }
            #settingsClose {
                float: right;
                z-index: 4;
                position: relative;
                top: -10px;
            }
            #settingsClose a {
                color: black;
            }
            .settingsRow {
                width: 100%;
                display: flex;
                justify-content: space-between;
                padding-bottom: 5px;
            }
            .settingsRow.sub {
                margin-left: 20px;
                display: block;
            }
            .settingsRow.sub span:first-of-type {
                width: 50px;
                display: inline-block;
            }
        </style>
    </head>
    <body>
        <div id="menu">
            <div id="bar">
                <a href="#" id="settings">settings</a> | <a href="#" id="volume">volume</a>
            </div>
            <div id="volumeControl">
                <svg width="40" height="150">
                    <rect width="6" height="130" x="17" y = "10" stroke="lightgray" fill="lightgray"/>
                    <circle cx="20" cy="16" r="12" stroke="black" fill="white" id="volumeSlider"/>
                </svg>
            </div>
        </div>
        <div id="settingsDialog">
            <div id="settingsClose"><a href="#">[x]</a></div>
            <h3>Instant settings</h3>
            <div class="settingsRow"><span>Horizontal Splits</span><input type="number" value="1" id="horizontalSplits" autocomplete="off"/></div>
            <div class="settingsRow"><span>Vertical Splits</span><input type="number" value="1" id="verticalSplits" autocomplete="off"/></div>
            <div class="settingsRow"><span>Next image (seconds)</span><input type="number" value="20" id="nextImageSec" autocomplete="off"/></div>
            <div class="settingsRow"><span>Background color (RGB, #ffc0cb)</span><input type="text" value="#ffc0cb" id="backgroundColor" title="RGB color in format #ffffff" autocomplete="off"/></div>
            <div class="settingsRow"><span>Background image</span></div>
            <div class="settingsRow sub"><span>Image</span><input type="file" accept=".png,.svg,.jpg,.gif,.webp" id="backgroundImage" autocomplete="off" /></div>
            <div class="settingsRow sub"><span>Mode</span><span><input type="radio" id="fit" name="imageMode" autocomplete="off" /><label for="fit"> fit</label> 
            <input type="radio" id="fill" name="imageMode" checked autocomplete="off" /><label for="fill"> fill</label></span></div>
            <div class="settingsRow sub"><span>Clear</span><button type="button" id="clearBackgroundImage">Clear</button></div>
            <h3>Settings that require refresh</h3>
            <div class="settingsRow"><span>Video split length (seconds)</span><input type="number" value="60" id="videoSplitLength" autocomplete="off"/></div>
            <button id="settingsApply">Apply and refresh</button>

        </div>
        <div id="welcome">
            <p>Welcome to GoonItUpNow's slideshow - Shitty look but great performance.</p>
            <p>Click button below to pick directory. Click settings to increase number of tiles. F11 for fullscreen mode.</p>
            <p>No data is actually uploaded, everything is processed locally on your computer.</p>
            <button id="browse">Pick folder</button>
            <p>Loading video metadata <span id="vidCurrent">0</span>/<span id="vidTotal">0</span></p>
        </div>
        <div id="slideshow-grid">
            <div class="slideshow-row">
                <div class="slideshow">
                    <img class="imgSlide"/>
                    <video class="videoSlide" autoplay controls></video>
                </div>
            </div>
        </div>
    </body>
</html>
